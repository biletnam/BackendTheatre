{"version":3,"sources":["../../../controllers/kidsInMind/kidsInMind.controller.js"],"names":["utils","reqPro","require","cheerio","searchMovies","req","res","next","url","params","movieName","then","htmlString","result","$","load","searchResults","find","i","length","temp","kimRating","movieKIMURL","attribs","href","children","idx","data","indexOf","substr","trim","push","json","message","catch","err","console","log","error","addKIMRating","mandatoryFields","checkReqBody","checkMandatoryRequestBody","body","imdbID","get","replace","tableName","columns","values","insertToDB","success","errResponse","module","exports"],"mappings":"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","file":"kidsInMind.controller.js","sourcesContent":["/**\n * Created by swapnil on 19/02/18.\n */\n'use strict';\nconst reqPro = require('request-promise');\nconst cheerio = require('cheerio');\nimport * as utils from '../../services/utils.service';\n\nconst searchMovies = (req, res, next) => {\n    let url = `http://www.kids-in-mind.com/cgi-bin/search/search.pl?q=\n    ${req.params.movieName}`;\n    reqPro(url)\n        .then(function (htmlString) {\n            let result = [];\n            const $ = cheerio.load(htmlString);\n            const searchResults = $('p[start=\"1\"]').find('a');\n            for (let i = 0; i < searchResults.length; i++) {\n                let temp = {\n                    movieName: null,\n                    kimRating: null,\n                    movieKIMURL: searchResults[i].attribs.href\n                };\n                let children = searchResults[i].children;\n                let idx = children[0].data.indexOf('[');\n                if (idx > -1) {\n                    temp.movieName = children[0].data.substr(0, idx - 1);\n                    temp.movieName = temp.movieName.trim();\n\n                    temp.kimRating = children[0].data.substr(idx - 1,\n                        children[0].data.length);\n                    temp.kimRating = temp.kimRating.trim();\n                    result.push(temp);\n                }\n            }\n            res.json({\n                message: 'success',\n                data: result\n            });\n        })\n        .catch(function (err) {\n            console.log(err);\n            next({error: err});\n        });\n};\n\n\nconst addKIMRating = (req, res, next) => {\n    // Check for mandatory fields\n    let mandatoryFields = ['movieKIMURL', 'kimRating', 'movieName'];\n    let checkReqBody = utils.checkMandatoryRequestBody(req.body, mandatoryFields);\n    if (checkReqBody.message !== 'success') {\n        return next({message: checkReqBody.message});\n    }\n    let url = req.body.movieKIMURL;\n\n    reqPro(url)\n        .then((htmlString) => {\n            const $ = cheerio.load(htmlString);\n            const searchResults = $('p[class=\"t11normal\"]').find('a');\n            let imdbID = searchResults.get(5).attribs.href;\n            imdbID = imdbID.replace('http://www.imdb.com/title/', '').replace('/', '');\n            let tableName = 'moviekidsinmind';\n\n            let columns = ['movieKIM_IMDB', 'movieKIM_MovieName', 'movieKIM_Rating'];\n\n            let values = [imdbID, req.body.movieName, req.body.kimRating];\n\n            utils.insertToDB(tableName, columns, values)\n                .then((success) => {\n                    res.json({\n                        message: 'Added rating of Kids in mind for ' + req.body.movieName,\n                        data: success.data\n                    });\n                }, (errResponse) => {\n                    next({message: errResponse.error});\n                });\n        })\n        .catch(function (err) {\n            console.log(err);\n            next({message: err});\n        });\n};\n\nmodule.exports = {\n    searchMovies: searchMovies,\n    addKIMRating: addKIMRating\n};\n"]}